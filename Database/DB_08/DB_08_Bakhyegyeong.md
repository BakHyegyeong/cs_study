# 트랜잭션

: 하나의 논리적 기능을 수행하기 위한 작업의 단위
→ 여러 개의 쿼리들을 하나로 묶는 단위

1. 원자성
2. 일관성
3. 격리성
4. 지속성

## 원자성(**automicity**)

: 트랜잭션과 관련된 일이 **모두 수행되었거나 되지 않는 것을 보장**하는 것
→ 이때 외부 API를 호출하는 과정은 없거나 롤백이 일어났을 때 어떻게 해결할 것인지에 대한 방안이 있어야 한다.

1. 원자성을 보장하기 위한 방안
    - 커밋 : 쿼리가 성공적으로 처리되었다고 확정하는 명령어
    → 커밋 후에 데이터베이스에 영구적으로 저장된다.
    - 롤백 : 트랜잭션이 일어나기 전으로 돌리는 일(취소)

    → 커밋과 롤백을 통해서 데이터의 무결성이 보장된다.

1. 트랜잭션 전파 : 트랜잭션 관련 메서드의 호출을 하나의 트랜잭션에 묶이도록 하는 것 <br>
→ **이미 트랜잭션이 진행중일 때 추가 트랜잭션 진행을 어떻게 할지 결정하는 것**

## 일관성(**consistency**)

: 허용된 방식으로만 데이터를 변경하는 것

ex) 잔액이 50만원인데 송금을 100만원 하는 것은 불가능하다.

## 격리성(**isolation**)

: 트랜잭션 수행 시 서로 끼어들지 못하는 것

→ 기본적으로 데이터베이스는 여러 사용자가 같은 데이터에 접근할 수 있어야 하므로 격리성은 여러 개의 격리 수준으로 나뉘어진다.

1. 격리 수준
    
    
    ![](https://velog.velcdn.com/images/kim_dg/post/9727355f-f112-4c1e-958a-7300949e06a8/image.png)
    
    - SERIALIZABLE : 트랜잭션을 **순차적으로** 진행시키는 것 <br>
    → **여러 트랜잭션이 같은 행에 접근할 수 없다.**
        
        → 교착 상태가 일어날 확률이 높고 가장 성능이 떨어진다.
        
    - REPEATABLE_READ : 다른 트랜잭션이 수정할 수 없도록 막지만 새로운 행을 추가하는 것은 가능하게 하는 것 <br>
    → 트랜잭션 수행시 **수정은 막지만 삽입은 막지 않는 것**
    - **READ_COMMITTED** : 가장 많이 사용되며 **커밋 완료된 데이터에 대해서만 조회를 허용하지만 트랜잭션간의 수정을 막지 않는 것**
    → 트랜잭션안에서 조회시 데이터가 달라질 수 있다.
    - READ_UNCOMMITTED : 가장 낮은 격리 수준으로 커밋이 되기 전에 다른 트랜잭션이 접근할 수 있다. <br>
    → 보통은 무결성을 위해 사용하지 않으나 거대한 양의 데이터를 집계할 때 사용된다.

2. 격리 수준에 따른 현상
    - 팬텀 리드 : 한 트랜잭션 내에서 동일한 쿼리를 사용했음에도 불구하고 조회 결과가 달라지는 것 <br>
    → **조건문을 통한 조회 결과가 달라지는 것**
    - 반복 가능하지 않은 조회 : 한 트랜잭션 내에서 같은 행에 두 번 이상의 조회가 발생했을 때 각각의 결과가 달라지는 것 <br>
    → **한 행의 조회 결과가 달라지는 것**
    - 더티 리드 : 커밋되지 않은 행의 변경된 데이터를 보는 것

## 지속성(**durability**)

: 성공적으로 수행된 트랜잭션은 영원히 반영되어야 하는 것

→ 시스템 장애가 발생해도 원래 상태로 복구하는 **회복 기능**이 있어야 한다.

- 체크섬 : 중복 검사, 오류 정정을 통해 송신된 자료의 무결성을 보호
- 저널링 : 트랜잭션에 대한 로그를 남기는 것
- 롤백

<br>

---

# Commit 과 Rollback

![](https://velog.velcdn.com/images/calla3494qhk/post/92491b09-dd77-445e-b512-be575d4ec96a/image.png)

- `commit` : 올바르게 적용된 데이터를 데이터베이스에 반영시키는 것
- `rollback` : 트랜잭션 시작 이전의 상태로 되돌리는 것 <br>
    → 트랜잭션의 대상이 되는 SQL문은 UPDATE, INSERT, DELETE 등 데이터를 수정하는 DML 문이다. 

## **COMMIT, ROLLBACK 이전의 데이터 상태**

- 단지 메모리 BUFFER에만 영향을 받았기 때문에 데이터의 변경 이전 상태로 복구 가능하다.
- 현재 사용자만이 SELECT 문장으로 결과를 확인 가능하다.
    
    → **다른 사용자는 현재 사용자가 수행한 명령의 결과를 볼 수 없다.**
    
- **변경된 행은 잠금 설정**되어서 다른 사용자가 변경할 수 없다.

## **COMMIT 이후의 데이터 상태**

- 데이터에 대한 변경 사항이 **데이터베이스에 영구히 반영**된다.
    
    → 이전 데이터는 사라져 복구할 수 없다.
    
- 모든 사용자는 결과를 볼 수 있다.
- 관련된 행에 대한 잠금이 풀리고, 다른 사용자들이 행을 조작할 수 있게 된다.

## **ROLLBACK 이후의 데이터 상태**

- 데이터에 대한 변경 사항이 취소된다.
- 이전 데이터는 다시 재저장된다.
- 관련된 행에 대한 잠금이 풀리고, 다른 사용자들은 행을 조작할 수 있게 된다.

## **COMMIT과 ROLLBACK로 얻는 효과**

- **데이터 무결성**을 보장한다.
- 영구적인 변경을 하기 전에 데이터의 변경 사항을 확인할 수 있다.
- 논리적인 연관된 작업을 그룹핑하여 처리할 수 있다.
