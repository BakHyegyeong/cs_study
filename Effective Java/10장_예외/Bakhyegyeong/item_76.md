# 아이템 76 : 가능한 한 실패 원자적으로 만들라

# 실패 원자적

호출된 메서드가 실패하더라도 해당 객체는 메서드 호출 전 상태(**정상적으로 사용할 수 있는 상태**)를 유지해야 한다.

## 실패 원자적으로 만드는 방법

1. 메서드를 불변 객체로 설계
2. 가변 객체의 메서드의 작업 수행 전에 매개변수의 유효성을 검사
    
    ```java
    public Object pop() {
    	// 매개변수 유효성 검사
      if (size == 0)
          throw new EmptyStackException();
      Object result = elements[--size];
      elements[size] = null; // 다 쓴 참조 해제
      return result;
    }
    ```
    
3. 실패할 가능성이 있는 모든 코드를, 객체의 상태를 바꾸는 코드보다 앞에 배치
4. 객체의 임시 복사본에서 작업을 수행한 다음, 작업이 성공적으로 완료되면 원래 객체와 교체
    
    → 데이터를 임시 자료구조에 저장해 작업하는 게 더 빠를 때 적용하기 좋은 방식이다.
    
5. 작업 도중 발생하는 실패를 가로채는 복구 코드를 작성하여 작업 전 상태로 되돌리기
    
    → 주로 디스크 기반의 내구성을 보장해야 하는 자료구조에 쓰이는 방식으로 자주 쓰이지는 않는다.
    

## 핵심 정리

- 메서드 명세에 기술한 예외라면 설혹 예외가 발생하더라도 객체의 상태는 메서드 호출 전과 똑같이 유지돼야 한다는 것이 기본 규칙이다.
- 지키지 못한다면 실패 시의 객체 상태를 API 설명에 명시해야 한다.